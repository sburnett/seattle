"""
<Program Name>
  z_test_client.repy

<Started>
  February 13, 2009

<Purpose>
  To test that Client functions work together.

  Passes quietly
"""
include client.repy

if callfunc == 'initialize':
  DEST_IP = 'whatever'
  DEST_PORT = 12345
  SRC_IP = 'whateversrc'
  SRC_PORT = 12346
  TIMEOUT = 5
  RETRIES = 4  
  MSS = 2
  CONG_WINDOW_SIZE = MSS
  HUGE = MSS * 100

def test_client():
  mycontext['packet_count'] = 0
  mycontext['packets'].clear()
  mycontext['packetc'].clear()
  
  SEQ_NUM = 2
  ACK_NUM = SEQ_NUM + 1
  DATA = "h"
  SND_WINDOW= 10
  RCV_WINDOW= 20
  CONG_MULT = 1

  mycontext['conn'].register_sendmess = ack_all_register
  mycontext['client'] = TcpClient(mycontext['conn'])
  cli = mycontext['client']
  cli.last_seq_sent = SEQ_NUM
  cli.last_ack_recv = ACK_NUM
  cli.recv_window_size= RCV_WINDOW
  cli.send_window_size= SND_WINDOW
  cli.cong_window_mult= CONG_MULT
  cli.send(DATA, DEST_IP, DEST_PORT, SRC_IP, SRC_PORT,RETRIES, TIMEOUT)

  assert  len(mycontext['packets']) == 1
  assert ACK_NUM in mycontext['packets'].keys()
  assert mycontext['packets'][ACK_NUM].is_payload()
  assert cli.last_ack_recv == ACK_NUM + len(DATA)
  assert cli.last_seq_sent == SEQ_NUM + len(DATA)
  assert mycontext['packet_count'] == 1
  assert mycontext['packets'][ACK_NUM].srcport == SRC_PORT
  assert mycontext['packets'][ACK_NUM].destport == DEST_PORT
  assert mycontext['packets'][ACK_NUM].window == RCV_WINDOW
  assert mycontext['packets'][ACK_NUM].ack_num == 0
  assert mycontext['packets'][ACK_NUM].seq_num == ACK_NUM


def test_client_window():
  mycontext['packet_count'] = 0
  mycontext['packets'].clear()
  mycontext['packetc'].clear()
  
  SEQ_NUM = 2
  ACK_NUM = SEQ_NUM + 1
  DATA = "hihihihi"
  SND_WINDOW= HUGE
  RCV_WINDOW= HUGE
  CONG_MULT = HUGE

  mycontext['conn'].register_sendmess = ack_all_register
  mycontext['client'] = TcpClient(mycontext['conn'])
  cli = mycontext['client']
  cli.last_seq_sent = SEQ_NUM
  cli.last_ack_recv = ACK_NUM
  cli.recv_window_size= RCV_WINDOW
  cli.send_window_size= SND_WINDOW
  cli.cong_window_mult= CONG_MULT
  cli.send(DATA, DEST_IP, DEST_PORT, SRC_IP, SRC_PORT,RETRIES, TIMEOUT)

  assert  len(mycontext['packets']) == len(DATA)/MSS
  assert ACK_NUM in mycontext['packets'].keys()
  assert (ACK_NUM + MSS) in mycontext['packets'].keys()
  assert (ACK_NUM + 2 * MSS) in mycontext['packets'].keys()
  assert (ACK_NUM + 3 * MSS) in mycontext['packets'].keys()

  assert cli.last_ack_recv == ACK_NUM + len(DATA)
  assert cli.last_seq_sent == SEQ_NUM + len(DATA)

def test_client_sliding_window():
  mycontext['packet_count'] = 0
  mycontext['packets'].clear()
  mycontext['packetc'].clear()
  
  SEQ_NUM = 2
  ACK_NUM = SEQ_NUM + 1
  DATA = "hihihihi"
  SND_WINDOW= HUGE
  RCV_WINDOW= HUGE
  CONG_MULT = HUGE

  mycontext['conn'].register_sendmess = ack_first_register
  mycontext['client'] = TcpClient(mycontext['conn'])
  cli = mycontext['client']
  cli.last_seq_sent = SEQ_NUM
  cli.last_ack_recv = ACK_NUM
  cli.recv_window_size= RCV_WINDOW
  cli.send_window_size= SND_WINDOW
  cli.cong_window_mult= CONG_MULT
  cli.send(DATA, DEST_IP, DEST_PORT, SRC_IP, SRC_PORT,RETRIES, TIMEOUT)

  assert  len(mycontext['packets']) == len(DATA)/MSS
  assert ACK_NUM in mycontext['packetc'].keys()
  assert (ACK_NUM + MSS) in mycontext['packetc'].keys()
  assert (ACK_NUM + 2 * MSS) in mycontext['packetc'].keys()
  assert (ACK_NUM + 3 * MSS) in mycontext['packetc'].keys()

  assert mycontext['packetc'][ACK_NUM] == 1
  assert mycontext['packetc'][ACK_NUM + 1 * MSS] == 2
  assert mycontext['packetc'][ACK_NUM + 2 * MSS] == 3
  assert mycontext['packetc'][ACK_NUM + 3 * MSS] == 4

  assert cli.last_ack_recv == ACK_NUM + len(DATA)
  assert cli.last_seq_sent == SEQ_NUM + len(DATA)

def test_client_congestion_window():
  mycontext['packet_count'] = 0
  mycontext['packets'].clear()
  mycontext['packetc'].clear()
  
  SEQ_NUM = 2
  ACK_NUM = SEQ_NUM + 1
  DATA = "hihihihi"
  SND_WINDOW= HUGE
  RCV_WINDOW= HUGE
  CONG_MULT = 1

  mycontext['conn'].register_sendmess = ack_first_register
  mycontext['client'] = TcpClient(mycontext['conn'])
  cli = mycontext['client']
  cli.last_seq_sent = SEQ_NUM
  cli.last_ack_recv = ACK_NUM
  cli.recv_window_size= RCV_WINDOW
  cli.send_window_size= SND_WINDOW
  cli.cong_window_mult= CONG_MULT
  cli.send(DATA, DEST_IP, DEST_PORT, SRC_IP, SRC_PORT, RETRIES, TIMEOUT)

  assert  len(mycontext['packets']) == len(DATA)/MSS
  assert ACK_NUM in mycontext['packetc'].keys()
  assert (ACK_NUM + MSS) in mycontext['packetc'].keys()
  assert (ACK_NUM + 2 * MSS) in mycontext['packetc'].keys()
  assert (ACK_NUM + 3 * MSS) in mycontext['packetc'].keys()

  assert mycontext['packetc'][ACK_NUM] == 1
  assert mycontext['packetc'][ACK_NUM + 1 * MSS] == 1
  assert mycontext['packetc'][ACK_NUM + 2 * MSS] == 2
  assert mycontext['packetc'][ACK_NUM + 3 * MSS] == 2


  assert cli.cong_window_mult == len(DATA)/CONG_WINDOW_SIZE + 1
  assert cli.last_ack_recv == ACK_NUM + len(DATA)
  assert cli.last_seq_sent == SEQ_NUM + len(DATA)


####################
# Test Helper Functions
####################
class Connection:
  def register_sendmess(self, destip, destport, message, srcip = None, srcport = None):
    pass

def ack_all_register(destip, destport, message, srcip = None, srcport = None):
    pack = unpack(message)
    mycontext['packet_count'] +=1
    if not pack.seq_num in mycontext['packetc'].keys():
      mycontext['packetc'][pack.seq_num] = 1
    else:
      mycontext['packetc'][pack.seq_num] += 1
    mycontext['packets'][pack.seq_num] = pack
    bytes = len(pack.payload)

    # generate ACK yes-man style
    ack_pack = pack.copy()
    ack_pack.srcport =   pack.destport
    ack_pack.destport = pack.srcport
    ack_pack.seq_num = 0
    ack_pack.ack_num = pack.seq_num + bytes
    ack_pack.window = HUGE
    ack_pack.control_bits = "ACK"
    ack_pack.payload = "echo ACK-ing"
    settimer(0, mycontext['client'].process, (ack_pack,))

    return bytes

def ack_first_register(destip, destport, message, srcip = None, srcport = None):
    pack = unpack(message)
    mycontext['packet_count'] +=1
    if not pack.seq_num in mycontext['packetc'].keys():
      mycontext['packetc'][pack.seq_num] = 1
    else:
      mycontext['packetc'][pack.seq_num] += 1
    mycontext['packets'][pack.seq_num] = pack
    bytes = len(pack.payload)

    # the first packet in window
    if mycontext['client'].last_ack_recv == pack.seq_num:
      ack_pack = pack.copy()
      ack_pack.srcport =   pack.destport
      ack_pack.destport = pack.srcport
      ack_pack.seq_num = 0
      ack_pack.ack_num = pack.seq_num + bytes
      ack_pack.window = HUGE
      ack_pack.control_bits = "ACK"
      ack_pack.payload = "echo ACK-ing"
      settimer(0, mycontext['client'].process, (ack_pack,))
    else: # drop it  
      pass

    return bytes

def main():
  # setup
  mycontext['packet_count'] = 0
  mycontext['packets'] = {}
  mycontext['packetc'] = {} # packet counter 
  mycontext['conn'] = Connection()
  mycontext['client'] = None
  
  # Run tests
  test_client()
  test_client_window()
  test_client_sliding_window()
  test_client_congestion_window()

  # teardown
  exitall()

if callfunc == 'initialize':
  main()
