""" 
<Program Name>
  z_test_server_close.repy

<Started>
  February 22, 2009

<Purpose>
  To test that the function works.

  Passes quietly
"""
include server.repy

if callfunc == 'initialize':
  PORT= 1234
  IP = 'shsfa'

def test_close():
  serv = TcpServer(mycontext['conn'])
  serv.conn.register_sendmess = fin_register
  serv.last_ack_sent = 1
  packet = TcpPacket(PORT, PORT, 1, 0, "FIN", 0, "test")
  assert not serv.fin_rcvd
  settimer(0.01, serv.process, (IP, packet))
  serv.close(.1)
  assert serv.fin_rcvd
  assert mycontext['ackfin'].is_ack()

def test_close_already_closed():
  serv = TcpServer(None)
  serv.fin_rcvd = True
  serv.close(.1)
  assert serv.fin_rcvd

def test_close_timeout():
  serv = TcpServer(None)
  try:
    serv.close(.01)
  except TimeoutError:
    pass
  else:
    raise Exception("should raise timeout")
 
####################
# Test Helper Functions
####################
class Connection:
  def register_sendmess(self, destip, destport, mess, srcip=None, srcport=None): pass


def fin_register(destip, destport, mess):
  pack = unpack(mess)
  mycontext['ackfin'] = pack
  return 1

def main():
  # setup
  mycontext['conn'] = Connection()

  # Run tests
  test_close()
  test_close_already_closed()
  test_close_timeout()

  # teardown
  exitall()

if callfunc == 'initialize':
  main()

