include time.repy
include nmclient.repy

if callfunc == 'initialize':

  time_updatetime(34612)
  nmhandle = nmclient_createhandle(getmyip(), 1224)
  
  myhandleinfo = nmclient_get_handle_info(nmhandle)

  myhandleinfo['publickey'] = {'e': 1515278400394037168869631887206225761783197636247636149274740854708478416229147500580877416652289990968676310353790883501744269103521055894342395180721167L, 'n': 8811850224687278929671477591179591903829730117649785862652866020803862826558480006479605958786097112503418194852731900367494958963787480076175614578652735061071079458992502737148356289391380249696938882025028801032667062564713111819847043202173425187133883586347323838509679062142786013585264788548556099117804213139295498187634341184917970175566549405203725955179602584979965820196023950630399933075080549044334508921319264315718790337460536601263126663173385674250739895046814277313031265034275415434440823182691254039184953842629364697394327806074576199279943114384828602178957150547925812518281418481896604655037L}

  myhandleinfo['privatekey'] = {'q': 54058458609373005761636236344701348569916976061233632302656354317296914836524068463339023907975088241991695932495814481647444694298985642399081803007236201209469946258941304883759055364999601996691930482382846773100579600645226048615117420700557109784424679718473031043919444221865548436936151591443700338637L, 'p': 163005946735584933080904947630005844643976533101833337498275325109161034533761907731163804211972028706576149578068245770343911608552263828770803393409524864116386113730846986186991705365903821748069417335817777744060812709585990055899981036005918570773920278122250955465866247822703170432353212868019982497201L, 'd': 2240169959722743128383109799584344927620631289695753164608137553948562513840905705755472646965204244185778446323692147882435315849145863268402636875283224769523136754021661455550898853194946272632624967823932300133454648259819576163836968537588009990175504497443778516954738281566994011669204200464480373455393955376955298830900816876217755539224711550233098080437180969137329334691279693903616444969433587901167778818088572448203744563568733073397445832643374417179790887207750843422586891294093361764515116975052446191135748633217162309228939861802346846701415099277659436864814394138247474263285983065177006045103L}

  nmclient_set_handle_info(nmhandle, myhandleinfo)


  resourcedata = """
resource cpu .01
resource memory 10000000   # 10 MiB
resource diskused 8000000 # 8 MiB
resource events 5
resource filewrite 10000
resource fileread 10000
resource filesopened 2
resource insockets 2
resource outsockets 2
resource netsend 10000
resource netrecv 10000
resource loopsend 100000
resource looprecv 100000
resource lograte 3000
resource random 10

call gethostbyname_ex allow
call sendmess arg 1 is 11111 allow
call sendmess arg 1 is 12222 allow
call sendmess arg 1 is 13333 allow
call sendmess arg 1 is 14444 allow
call sendmess arg 1 is 15555 allow
call sendmess arg 1 is 16666 allow
call sendmess arg 1 is 17777 allow
call sendmess arg 1 is 18888 allow
call sendmess arg 1 is 19999 allow
call recvmess arg 1 is 11111 allow
call recvmess arg 1 is 12222 allow
call recvmess arg 1 is 13333 allow
call recvmess arg 1 is 14444 allow
call recvmess arg 1 is 15555 allow
call recvmess arg 1 is 16666 allow
call recvmess arg 1 is 17777 allow
call recvmess arg 1 is 18888 allow
call recvmess arg 1 is 19999 allow
call openconn arg 1 is 11111 allow
call openconn arg 1 is 12222 allow
call openconn arg 1 is 13333 allow
call openconn arg 1 is 14444 allow
call openconn arg 1 is 15555 allow
call openconn arg 1 is 16666 allow
call openconn arg 1 is 17777 allow
call openconn arg 1 is 18888 allow
call openconn arg 1 is 19999 allow
call waitforconn arg 1 is 11111 allow
call waitforconn arg 1 is 12222 allow
call waitforconn arg 1 is 13333 allow
call waitforconn arg 1 is 14444 allow
call waitforconn arg 1 is 15555 allow
call waitforconn arg 1 is 16666 allow
call waitforconn arg 1 is 17777 allow
call waitforconn arg 1 is 18888 allow
call waitforconn arg 1 is 19999 allow
call stopcomm allow                     # it doesn't make sense to restrict
call socket.close allow                 # let's not restrict
call socket.send allow                  # let's not restrict
call socket.recv allow                  # let's not restrict

# open and file.__init__ both have built in restrictions...
call open allow                         # can read / write
call file.__init__ allow                # can read / write
call file.close allow                   # shouldn't restrict
call file.flush allow                   # they are free to use
call file.next allow                    # free to use as well...
call file.read allow                    # allow read
call file.readline allow                # shouldn't restrict
call file.readlines allow               # shouldn't restrict
call file.seek allow                    # seek doesn't restrict
call file.write allow                   # shouldn't restrict (open restricts)
call file.writelines allow              # shouldn't restrict (open restricts)
call sleep allow                        # harmless
call settimer allow                     # we can't really do anything smart
call canceltimer allow                  # should be okay
call exitall allow                      # should be harmless 

call log.write allow
call log.writelines allow
call getmyip allow                      # They can get the external IP address
call listdir allow                      # They can list the files they created
call removefile allow                   # They can remove the files they create
call randomfloat allow                  # can get random numbers
call getruntime allow                   # can get the elapsed time
call getlock allow                      # can get a mutex
"""


  print nmclient_rawcommunicate(nmhandle, "GetVesselResources","v1")
  print nmclient_signedcommunicate(nmhandle, "SplitVessel", "v1", resourcedata)

  print nmclient_signedcommunicate(nmhandle, "JoinVessels", "v3", "v4")

  print nmclient_rawcommunicate(nmhandle, "GetVessels")

  print nmclient_rawcommunicate(nmhandle, "GetVesselResources","v5")
